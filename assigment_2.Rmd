---
title: 'ASSIGNMENT 2: Vote choice in Germany'
author: "Jordi Espasa & Eduard Masip"
date: "2022-11-10"
output:
  word_document: default
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 90
---

```{r, include=FALSE, echo=FALSE}
# Load Required Packages: to be increased over the course "ggmap""plotly""xlsx""kableExtra",
options(contrasts=c("contr.treatment","contr.treatment"))
requiredPackages <- c("missMDA","effects","FactoMineR","car",
                      "factoextra","RColorBrewer","ggplot2",
                      "dplyr","ggthemes","knitr","MASS",
                      "chemometrics","rpart","ROCR","corrr",
                      "readxl","RColorBrewer","ggplot2","PerformanceAnalytics",                           "corrplot","reshape2","scales","stargazer",
                      "cowplot","rapportools", "packHV", "chemometrics","lmtest",
                      "AER","nnet","MNLpred")


package.check <- lapply(requiredPackages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})

search()  #verify they are loaded

```

# Data Description

The data has 1000 individual observations .

-   Vote: Voting decision for party into 6 levels (represented parties in the Bundestag):

    -   "AfD": Alternative für Deutschland, right wing populist party (right)

    -   "CDU/CSU": Center-right Christian-democratic political alliance (center)

    -   "FDP": Free democratic party -- liberal party centre or centre-right of the
        political spectrum (center)

    -   "Gruene": Die Grünen -- "the Greens" (left)

    -   "LINKE": DIE LINKE the left party is a democratic socialist political party in
        Germany, it is the furthest left-wing party of the six represented in the
        Bundestag (left)

    -   "SPD": Social Democratic Party of Germany, center left (center).

-   egoposition_immigration: Ego-position toward immigration (0 = very open to 10 = very
    restrictive )

-   ostwest: Dummy for respondents from Eastern Germany (= 1)

-   political_interest: Measurement for political interst (0 = low, 4 = high)

-   income: Self-reported income satisfaction (0 = low, 4 = high)

-   gender: Self-reported gender (binary coding with 1 = female)

```{r include=FALSE}

if(!is.null(dev.list())) dev.off() # Clear plots
rm(list=ls()) # Clean workspace

#load("./gles.RData")

df <- gles

summary(df)
str(df)
```

# 1 - Data Preparation

## 1.1 - Removing duplicate or irrelevant observations

Since there is not a column that represents the uniqueness of every row, we can not check
if there are any duplicates

```{r include=FALSE}

idx_dup<-which(duplicated(df))
idx_dup
length(idx_dup)

#df<-unique(df)

```

## 1.2 - Fix structural errors and check data types

It seems that there are no coding errors. All factors are correctly defined.

We renamed the level factors with meaningful names that describe the factors to which they
belong. This helps us to better understand when creating the model.

```{r include=FALSE}

intervals <- c(0,2,4,6,8,10)

df$gegopos_immi <- factor(cut(df$egoposition_immigration,breaks=intervals))
table(df$gegopos_immi)

# mediana dintre de cada grup
cintervals<- tapply(df$egoposition_immigration,df$gegopos_immi,median)

# ngincome: numeric, mediana segons el grup al que pertany
df$ngegopos_immi<-factor(cut(df$egoposition_immigration,breaks=intervals))
df$ngegopos_immi<-factor(df$ngegopos_immi,labels=cintervals)
df$ngegopos_immi<-as.numeric(levels(df$ngegopos_immi))[df$ngegopos_immi]

# Set Factors
df$vote=as.factor(df$vote)
df$egoposition_immigration=as.factor(df$egoposition_immigration)
df$ostwest=as.factor(df$ostwest)
df$political_interest=as.factor(df$political_interest)
df$income=as.factor(df$income)
df$gender=as.factor(df$gender)
table(df$income)

# Rename levels for each factor
levels(df$vote) <- c("vote.AfD", "vote.CDU/CSU", "vote.FDP", "vote.Gruene", "vote.LINKE", "vote.SPD")
levels(df$egoposition_immigration) <- c("immgration.0", "immgration.1",
      "immgration.2", "immgration.3", "immgration.4", "immgration.5", "immgration.6", "immgration.7", "immgration.8", "immgration.9", "immgration.10")
levels(df$ostwest) <- c("ostwest.no", "ostwest.yes")
levels(df$political_interest) <- c("political_interest.low", "political_interest.low_medium","political_interest.medium", "political_interest.medium_high", "political_interest.high")
levels(df$income) <- c("income.low", "income.low_medium","income.medium", "income.medium_high", "income.high")
levels(df$gender) <- c("gender.male", "gender.female")

#Final structure
str(df)

```

## 1.3 - Filter unwanted outliers.

As all the variables are categorical, there are not outliers.

## 1.4 - Handle missing data

Neither individuals nor features has missing values.

```{r include=FALSE}
colnames(df)

# DETECTING MISSING VALUES
which(is.na(df$vote)) 
which(is.na(df$egoposition_immigration)) 
which(is.na(df$ostwest)) 
which(is.na(df$political_interest)) 
which(is.na(df$income)) 
which(is.na(df$gender)) 

# PER INDIVIDUAL
mis_ind = rowSums(is.na(df))
mis_ind
df[which(mis_ind>0),] # Show individuals with some NA value

# PER FEATURE
mis_col = colSums(is.na(df))
mis_col
df[,which(mis_col>0)] # Show features with some NA value

```

## 1.5 - Data balancing

We can observe that the dataset that we are working with it is unbalanced on its target
variable.

```{r include=FALSE}

voteTable <- data.frame("amount" = table(df$vote))

ggplot(voteTable, aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of votes (Target variable)") +
  theme_void() # remove background, grid, numeric labels

#(?) hem de balancejar el dataset? podem fer servir el que volguem? 


```

# 2 - Data Exploration

## 2.1 - Derivation of New variables

```{r include=FALSE}

#Dimension reduction of egoposition immigration from 10 to 3.
df$egoposition_immigration_red <- df$egoposition_immigration

levels(df$egoposition_immigration_red) <- list("immigration.open" = c("immgration.0", "immgration.1", "immgration.2"), 
    "immigration.mid" = c("immgration.3", "immgration.4","immgration.5"),
    "immigration.restrictive" = c("immgration.6", "immgration.7", "immgration.8", "immgration.9", "immgration.10"))

df$egoposition_immigration_red2 <- df$egoposition_immigration

levels(df$egoposition_immigration_red2) <- list("immigration.open" = c("immgration.0", "immgration.1", "immgration.2"), 
    "immigration.open_moderate" = c("immgration.3", "immgration.4"),
    "immigration.moderate" = c("immgration.3", "immgration.5"),
    "immigration.moderate_restrictive" = c("immgration.6", "immgration.7"),  "immigration.restrictive" = c("immgration.8", "immgration.9", "immgration.10"))

# Political Orientation
df$politicalOrientation <- df$vote

levels(df$politicalOrientation) <- list("politicalOrientation.right"=c("vote.AfD"),
            "politicalOrientation.center"=c("vote.CDU/CSU", "vote.FDP","vote.SPD"),
            "politicalOrientation.left"=c("vote.Gruene", "vote.LINKE"))


```

## 2.2 - Data Analysis

-   We can observe that we have more male voters.
-   We can oberve that there is a difference in the income between genders.
-   Political interest 0 is residual, may be we can delete it

```{r include=FALSE}

# TARGET VARIABLE: VOTE
pie(table(df$vote),labels = names(table(df$vote)), col=rainbow(length(table(df$vote))), main="Distribution of votes (Target variable)")

ggplot(df, aes(vote)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) +
  ylab("relative frequencies")

# EXPLANATORY VARIABLE

ggplot(data.frame("amount" = table(df$egoposition_immigration)), aes(x=amount.Var1, y=amount.Freq)) +
  geom_bar(stat = "identity") +
  xlab("Frequency") +
  ylab("egoposition_immigration") +
  ggtitle("Count of egoposition_immigration") +
  theme(plot.title = element_text(hjust = 0.5)) +
  coord_flip()


ggplot(data.frame("amount" = table(df$egoposition_immigration_red)), aes(x=amount.Var1, y=amount.Freq)) +
  geom_bar(stat = "identity") +
  xlab("Frequency") +
  ylab("egoposition_immigration") +
  ggtitle("Count of egoposition_immigration") +
  theme(plot.title = element_text(hjust = 0.5)) +
  coord_flip()

ggplot(data.frame("amount" = table(df$ostwest)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of ostwest") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Ostwest")

ggplot(data.frame("amount" = table(df$political_interest)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of political_interest") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Political Interest")

ggplot(data.frame("amount" = table(df$income)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of income") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Income")

ggplot(data.frame("amount" = table(df$gender)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of gender") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Gender")

colnames(df)
```

## 2.3 - Profiling Target Variable: Vote

```{r include=FALSE}

ggplot(df, aes(x= income,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$income))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="Income") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

ggplot(df, aes(x= gender,  group=vote)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$gender))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="Gender") +
    facet_grid(~vote) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

ggplot(df, aes(x= vote,  group=income)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$vote))), stat="count") +
    labs(y = "Percentage", fill="Vote") +
    facet_grid(~income) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


ggplot(df, aes(x= ostwest,  group=income)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$ostwest))), stat="count") +
    labs(y = "Percentage", fill="Ostwest") +
    facet_grid(~income) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


ggplot(df, aes(x= vote,  group=egoposition_immigration_red)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$vote))), stat="count") +
    labs(y = "Percentage", fill="Vote") +
    facet_grid(~egoposition_immigration_red) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

ggplot(df, aes(x= income,  group=egoposition_immigration_red)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$income))), stat="count") +
    labs(y = "Percentage", fill="Income") +
    facet_grid(~egoposition_immigration_red) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

#### MOURE ADALT?
names(df)
res.cat=catdes(df[,c(1,9,3,4,5,6)], 1) 
res.cat$test.chi2
res.cat$category

#plots of the variables that influentiate vote usign catdes

counts <- table(df$ostwest, df$vote)
barplot(counts, 
        xlab="Number of Votes", col=topo.colors(2),
        legend = rownames(counts),  beside=TRUE, 
        args.legend = list(x = "top"))


#As the dataset is very unbalanced we can apply porcentual plots.
ggplot(df, aes(x= gender,  group=vote)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$gender))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Gender") +
    facet_grid(~vote) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

## ORIENTACIÓ POLITCA VS GEnDER
ggplot(df, aes(x= politicalOrientation,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$politicalOrientation))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


## ORIENTACIÓ POLITCA VS egoposition_immigration_red
ggplot(df, aes(x= politicalOrientation,  group=egoposition_immigration_red2)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$politicalOrientation))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="day") +
    facet_grid(~egoposition_immigration_red2) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

ggplot(df, aes(x= ostwest,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$ostwest))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

ggplot(df, aes(x= political_interest,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$political_interest))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


### OSTWEST FILTERS

ggplot(df[df$ostwest=='ostwest.yes',], aes(x= political_interest,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$political_interest))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Interest (ostwest.yes)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# Curios les noies, a OSTWEST.NO tenen interes politic mes alt
ggplot(df[df$ostwest=='ostwest.no',], aes(x= political_interest,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$political_interest))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Interest (ostwest.no)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# CURIOS OSTWEST.NO els vots Masculins i Femenins estan mes radicalitzats
ggplot(df[df$ostwest=='ostwest.yes',], aes(x= politicalOrientation,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$politicalOrientation))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation (ostwest.yes)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


ggplot(df[df$ostwest=='ostwest.no',], aes(x= politicalOrientation,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$politicalOrientation))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation (ostwest.no)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


############################ MIRARHO PER PARTITS POLITICS!
ggplot(df[df$ostwest=='ostwest.yes',], aes(x= vote,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$vote))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation (ostwest.yes)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


ggplot(df[df$ostwest=='ostwest.no',], aes(x= vote,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$vote))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation (ostwest.no)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# Figure 3-6: Distribution of votes grouped by income
ggplot(df, aes(x=vote,  group=income)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$vote))), stat="count") +
    labs(y = "Percent", fill="Vote") +
    facet_grid(~income) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# Figure 3-7: Distribution of AfD votes by gender grouped by income
ggplot(df[df$vote=='vote.AfD',], aes(x=gender,  group=income)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$gender))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Income (vote=AfD)") +
    facet_grid(~income) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# Figure 3-8: Distribution of immigration opinion grouped by political parties
ggplot(df, aes(x= egoposition_immigration_red,  group=vote)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$egoposition_immigration_red))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="egoposition_immigration_red") +
    facet_grid(~vote) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

#  Figure 3-9: Distribution of AfD votes by income grouped by immigration opinion
ggplot(df[df$vote=='vote.AfD',], aes(x=income,  group=egoposition_immigration_red)) + 
    geom_bar(aes(y = ..count.., fill = factor(..x..,labels=levels(df$income)[2:5])), stat="count") +
    geom_text(aes( label = ..count..,
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Frequency", fill="Income (vote=AfD)") +
    facet_grid(~egoposition_immigration_red) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

#  Figure 3-13: Distribution of Gruene votes by gender grouped by income
ggplot(df[df$vote=='vote.Gruene',], aes(x=gender,  group=income)) + 
    geom_bar(aes(y = ..count.., fill = factor(..x..,labels=levels(df$gender))), stat="count") +
    geom_text(aes( label = ..count..,
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Frequency", fill="Income (vote=Gruene)") +
    facet_grid(~income) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

```

## 2.4 - Profiling Political Orientation

```{r include=FALSE}

names(df)
res.cat=catdes(df[,c(11,9,3,4,5,6)], 1) 
res.cat$test.chi2
res.cat$category

# Figure 3-16: Distribution of politicalOrientation
ggplot(data.frame("amount" = table(df$politicalOrientation)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of politicalOrientation") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Political Orientation")

# Figure 3-18: Distribution of politicalOrientation grouped by ostwest
ggplot(data.frame("amount" = table(df[df$ostwest=='ostwest.no',]$politicalOrientation)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of Ostwest:No votes") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Political Interest")
ggplot(data.frame("amount" = table(df[df$ostwest=='ostwest.yes',]$politicalOrientation)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of Ostwest:Yes votes") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Political Interest")

# Figure 3-20: Distribution of immigration opinion grouped by politicalOrientation
ggplot(df, aes(x= egoposition_immigration_red,  group=politicalOrientation)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$egoposition_immigration_red))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="egoposition_immigration_red") +
    facet_grid(~politicalOrientation) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# political orientation x gender
ggplot(df, aes(x= gender,  group=politicalOrientation)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$gender))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="gender") +
    facet_grid(~politicalOrientation) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


# political orientation x ostwest
ggplot(df, aes(x= ostwest,  group=politicalOrientation)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$ostwest))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="ostwest") +
    facet_grid(~politicalOrientation) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() )


# political orientation x income
ggplot(df, aes(x= income,  group=politicalOrientation)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$income))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="income") +
    facet_grid(~politicalOrientation) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() )




```

# 3 - Feature Selection

```{r include=FALSE}

```

# 4 - Modeling

## 4.1 - Modeling using numeric variables using transformations if needed.

```{r include=FALSE}

# With baseline reparametrization (To mantain the configuration)
options(contrasts=c("contr.treatment","contr.treatment"))

```

La idea es entrenar un model binomial per a poder dividir millor en political orientation. Sin embargo aquest model es una puta basura i per tant considero que el fara millor dividir right de center i left

#Binary model for right+center / left
```{r}

df$politicalOrientationBinary2<-ifelse(df$politicalOrientation=="politicalOrientation.left",1,0)
df$politicalOrientationBinary2<-factor(df$politicalOrientationBinary2,labels=c("center_right","left"))


set.seed(123456)
llwork <- sample(1:nrow(df),round(0.8*nrow(df),dig=0))
dfwork <- df[llwork,]
dftest <- df[-llwork,]



bm1 <- glm( politicalOrientationBinary2 ~ 1, family="binomial",data=dfwork)
bm2 <- glm( politicalOrientationBinary2 ~ egoposition_immigration+political_interest+income+gender+ostwest, family="binomial",data=dfwork)
bm3 <- glm( politicalOrientationBinary2 ~ egoposition_immigration + gender + ostwest, family="binomial",data=dfwork)


bm2$null.dev - bm2$dev
bm3$null.dev - bm3$dev


AIC(bm2, bm3) # hm1m3 325.7325
step(bm2)
anova(bm2, bm3, test="Chisq")
plot(allEffects(bm3))



pred <- predict(bm3, newdata = dftest, type = "response")

dftest$predictions <- pred
dftest$idx <- c(1:length(dftest$predictions))

ggplot(dftest, aes(x=idx, y=predictions, color=politicalOrientationBinary2)) +
  geom_point()

pred <- ifelse(pred > 0.5,1,0)

tt <- table(pred, dftest$politicalOrientationBinary)
tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))


```


aquest model al principi es una puta basura pero despres millora una mica quan recalculo al threshold.


#Binary model for right / left+center
```{r}
set.seed(123456)
llwork <- sample(1:nrow(df),round(0.8*nrow(df),dig=0))
dfwork <- df[llwork,]
dftest <- df[-llwork,]


df$politicalOrientationBinary<-ifelse(df$politicalOrientation=="politicalOrientation.right",1,0)
df$politicalOrientationBinary<-factor(df$politicalOrientationBinary,labels=c("left_center","right"))


bm1 <- glm( politicalOrientationBinary ~ 1, family="binomial",data=dfwork)
bm2 <- glm( politicalOrientationBinary ~ egoposition_immigration+political_interest+income+gender+ostwest, family="binomial",data=dfwork)
bm3 <- glm( politicalOrientationBinary ~ egoposition_immigration + gender + ostwest, family="binomial",data=dfwork)


bm2$null.dev - bm2$dev
bm3$null.dev - bm3$dev


AIC(bm2, bm3) # hm1m3 325.7325
step(bm2)
anova(bm2, bm3, test="Chisq")
plot(allEffects(bm3))


pred <- predict(bm3, newdata = dftest, type = "response")

dftest$predictions <- pred
dftest$idx <- c(1:length(dftest$predictions))

ggplot(dftest, aes(x=idx, y=predictions, color=politicalOrientationBinary)) +
  geom_point()

pred <- ifelse(pred > 0.13,1,0)

tt <- table(pred, dftest$politicalOrientationBinary)
tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))

```


#Multinom model for right / center / left
```{r}

set.seed(123456)
llwork <- sample(1:nrow(df),round(0.8*nrow(df),dig=0))
dfwork <- df[llwork,]
dftest <- df[-llwork,]

?multinom

ones<-c(rep(1, 1000))
mm0 <-multinom( politicalOrientation~1, data=df,weight=ones)
mm1 <-multinom( politicalOrientation~egoposition_immigration_red, data=df,weight=ones )
mm2 <-multinom( politicalOrientation~ostwest, data=df,weight=ones )
mm3 <-multinom( politicalOrientation~political_interest, data=df,weight=ones )
mm4 <-multinom( politicalOrientation~income, data=df,weight=ones )
mm5 <-multinom( politicalOrientation~gender, data=df,weight=ones )
mm6 <-multinom( politicalOrientation~egoposition_immigration_red2, data=df,weight=ones )
mm7 <-multinom( politicalOrientation~egoposition_immigration, data=df,weight=ones )
mm8 <-multinom( politicalOrientation~egoposition_immigration_red+gender, data=df,weight=ones )
mm9 <-multinom( vote~egoposition_immigration+political_interest+income+gender+ostwest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])), Hess=TRUE )
mm10 <-multinom( politicalOrientation ~ egoposition_immigration+political_interest+income+gender+ostwest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])), Hess=TRUE )
mm11 <-multinom( politicalOrientation ~ egoposition_immigration+political_interest+income+gender+ostwest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])), Hess=TRUE )
mm12 <- step(mm10)

#comparar modelos
mm0$dev - mm10$dev
AIC(mm10)
AIC(hm1m1,hm1m4,hm1m2, hm1m3,hm1m6) 
anova(hm1m8, hm1m9, test="Chisq")

df.fin <- mm10
prob.vote <- df.fin$fit
tt <- table(predict(mm10,  dftest, type='class'), dftest$politicalOrientation)
tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))




#Efectos modelos
plot(allEffects(hm1m3))

# Sons effect
coef(hm1m3)
exp(coef(hm1m3))
100*(exp((coef(hm1m3))[2]) - 1)
# Having sons decreases on average the relative probability of working vs non_working by 79.31% all else being equal
prop.table(table(womenlf$bwork))

# Income effect: odds of working decrease for each year by 4.14% and in 0.01 probability units
coef(hm1m3)[3]
exp(coef(hm1m3))[3]
100*(exp(coef(hm1m3))[3] - 1)
```





























```{r}
ones<-c(rep(1, 1000))
mm0 <-multinom( politicalOrientation~1, data=df,weight=ones)
mm1 <-multinom( politicalOrientation~egoposition_immigration_red, data=df,weight=ones )
mm2 <-multinom( politicalOrientation~ostwest, data=df,weight=ones )
mm3 <-multinom( politicalOrientation~political_interest, data=df,weight=ones )
mm4 <-multinom( politicalOrientation~income, data=df,weight=ones )
mm5 <-multinom( politicalOrientation~gender, data=df,weight=ones )
mm6 <-multinom( politicalOrientation~egoposition_immigration_red2, data=df,weight=ones )
mm7 <-multinom( politicalOrientation~egoposition_immigration, data=df,weight=ones )
mm8 <-multinom( politicalOrientation~egoposition_immigration_red+gender, data=df,weight=ones )
mm9 <-multinom( vote~egoposition_immigration+political_interest+income+gender+ostwest, data=df,weight=ones, Hess=TRUE )
mm10 <-multinom( politicalOrientation~egoposition_immigration+political_interest+income+gender+ostwest, data=df,weight=ones, Hess=TRUE )

# https://rdrr.io/cran/MNLpred/f/vignettes/OVA_Predictions_For_MNL.Rmd


AIC(mm0, mm1,mm2,mm3,mm4,mm5,mm6, mm7,mm8,mm9, mm10) # mm1 mm6 mm7 mm8 mm10
predict(mm10,type="class")[987]
df$politicalOrientation[987]
plot(allEffects(mm7))
summary(mm9)

#ojo
pred1 <- mnl_pred_ova(model = mm9,
                      data = df,
                      x = "egoposition_immigration",
                      by = 1,
                      seed = "random", # default
                      nsim = 100, # faster
                      probs = c(0.025, 0.975)) # default

ggplot(data = pred1$plotdata, aes(x = egoposition_immigration, 
                                  y = mean,
                                  ymin = lower, ymax = upper)) +
  geom_ribbon(alpha = 0.1) + # Confidence intervals
  geom_line() + # Mean
  facet_wrap(.~ vote, scales = "free_y", ncol = 2) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) + # % labels
  scale_x_continuous(breaks = c(0:10)) +
  theme_bw() +
  labs(y = "Predicted probabilities",
       x = "Ego-position toward immigration") # Always label your axes ;)
```




```{r}
## SPLIT

set.seed(010195)
llwork <- sample(1:nrow(gles),round(0.8*nrow(gles),dig=0))
dfwork <- gles[llwork,]
dftest <- gles[-llwork,]

mm9 <-multinom( vote~egoposition_immigration+political_interest+income+gender+ostwest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])), Hess=TRUE )

gles.fin <- mm9
prob.vote <- gles.fin$fit
tt <- table(predict(mm9,type="class"),dfwork$vote)
tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))


# Model na?ve
m0 <-multinom( vote~1, data=dfwork,weight=c(rep(1, dim(dfwork)[1])), Hess=TRUE )
tt <- table(predict(m0,type="class"),dfwork$vote)
tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))
```

```{r}

df$imm<-gles$egoposition_immigration

## SPLIT
llwork <- sample(1:nrow(df),round(0.8*nrow(df),dig=0))
dfwork <- df[llwork,]
dftest <- df[-llwork,]

mm9 <-multinom( vote~imm*gender*ostwest*political_interest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))

mm91 <-multinom( vote~egoposition_immigration_red+political_interest+income+gender+ostwest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))

mm91.2 <-multinom( vote~egoposition_immigration_red2+political_interest+income+gender+ostwest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))

mm91.1 <-multinom( vote~egoposition_immigration_red+political_interest+income+ostwest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))

AIC(mm9,mm91,mm91.1)
hist(df$imm)
smm9<-
step(mm9)
smm91<-step(mm91)
smm91.1<-step(mm91.1)

AIC(smm9,smm91,smm91.1)

mm92 <-multinom( vote~egoposition_immigration_red2+political_interest+income+gender+ostwest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))

lda(df, Attrition~x1+x2+x3*x4)

om0<-polr(  vote~1, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))
om1 <-polr(  vote~egoposition_immigration, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))
om2 <-polr(  vote~political_interest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))
om3 <-polr(  vote~egoposition_immigration+political_interest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))
om3.1 <-polr(  vote~gegopos_immi+political_interest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))
om4 <-polr(  vote~egoposition_immigration_red+political_interest+income+gender+ostwest, data=dfwork,weight=c(rep(1, dim(dfwork)[1])))


anova(om0,om1,test='Chisq' )
anova(om0,om2,test='Chisq' )
anova(om1,om2,test='Chisq' )
anova(om3,om2,test='Chisq' )
anova(om3,om3.1,test='Chisq' )
anova(om4,om3,test='Chisq' )

AIC(mm9,mm91,mm92,mm91.1)

checkModel<-mm91

gles.fin <- checkModel
prob.vote <- gles.fin$fit
tt <- table(predict(checkModel,type="class"),dfwork$vote)
tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))
```

## 4.2 - Adding factor main effects to the best model containing numeric variables

## 4.3 - Adding factor main effects and interactions (limit your statement to order 2) to the best model containing numeric variables.

## 4.4 - Goodness of fit and Model Interpretation for each proposal (nominal/ordinal).

## 4.5 - Goodness of fit and Model Interpretation for political orientation (right/center/left). Make your own allocation of political parties to the right/center/left wing orientation.
