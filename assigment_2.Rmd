---
title: 'ASSIGNMENT 2: Vote choice in Germany'
author: "Jordi Espasa & Eduard Masip"
date: "2022-11-10"
output:
  word_document: default
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 90
---

```{r, include=FALSE, echo=FALSE}
# Load Required Packages: to be increased over the course "ggmap""plotly""xlsx""kableExtra",
options(contrasts=c("contr.treatment","contr.treatment"))
requiredPackages <- c("missMDA","effects","FactoMineR","car",
                      "factoextra","RColorBrewer","ggplot2",
                      "dplyr","ggthemes","knitr","MASS",
                      "chemometrics","rpart","ROCR","corrr",
                      "readxl","RColorBrewer","ggplot2","PerformanceAnalytics",                           "corrplot","reshape2","scales","stargazer",
                      "cowplot","rapportools", "packHV", "chemometrics","lmtest",
                      "AER","nnet","MNLpred")


package.check <- lapply(requiredPackages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})

search()  #verify they are loaded

```

# Data Description

The data has 1000 individual observations .

-   Vote: Voting decision for party into 6 levels (represented parties in the Bundestag):

    -   "AfD": Alternative für Deutschland, right wing populist party (right)

    -   "CDU/CSU": Center-right Christian-democratic political alliance (center)

    -   "FDP": Free democratic party -- liberal party centre or centre-right of the
        political spectrum (center)

    -   "Gruene": Die Grünen -- "the Greens" (left)

    -   "LINKE": DIE LINKE the left party is a democratic socialist political party in
        Germany, it is the furthest left-wing party of the six represented in the
        Bundestag (left)

    -   "SPD": Social Democratic Party of Germany, center left (center).

-   egoposition_immigration: Ego-position toward immigration (0 = very open to 10 = very
    restrictive )

-   ostwest: Dummy for respondents from Eastern Germany (= 1)

-   political_interest: Measurement for political interst (0 = low, 4 = high)

-   income: Self-reported income satisfaction (0 = low, 4 = high)

-   gender: Self-reported gender (binary coding with 1 = female)

```{r include=FALSE}

if(!is.null(dev.list())) dev.off() # Clear plots
rm(list=ls()) # Clean workspace

#load("./gles.RData")

df <- gles

summary(df)
str(df)
```

# 1 - Data Preparation

## 1.1 - Removing duplicate or irrelevant observations

Since there is not a column that represents the uniqueness of every row, we can not check
if there are any duplicates

```{r include=FALSE}

idx_dup<-which(duplicated(df))
idx_dup
length(idx_dup)

#df<-unique(df)

```

## 1.2 - Fix structural errors and check data types

It seems that there are no coding errors. All factors are correctly defined.

We renamed the level factors with meaningful names that describe the factors to which they
belong. This helps us to better understand when creating the model.

```{r include=FALSE}

intervals <- c(0,2,4,6,8,10)

df$gegopos_immi <- factor(cut(df$egoposition_immigration,breaks=intervals))
table(df$gegopos_immi)

# mediana dintre de cada grup
cintervals<- tapply(df$egoposition_immigration,df$gegopos_immi,median)

# ngincome: numeric, mediana segons el grup al que pertany
df$ngegopos_immi<-factor(cut(df$egoposition_immigration,breaks=intervals))
df$ngegopos_immi<-factor(df$ngegopos_immi,labels=cintervals)
df$ngegopos_immi<-as.numeric(levels(df$ngegopos_immi))[df$ngegopos_immi]

# Set Factors
df$vote=as.factor(df$vote)
df$egoposition_immigration=as.factor(df$egoposition_immigration)
df$ostwest=as.factor(df$ostwest)
df$political_interest=as.factor(df$political_interest)
df$income=as.factor(df$income)
df$gender=as.factor(df$gender)
table(df$income)

# Rename levels for each factor
levels(df$vote) <- c("vote.AfD", "vote.CDU/CSU", "vote.FDP", "vote.Gruene", "vote.LINKE", "vote.SPD")
levels(df$egoposition_immigration) <- c("immgration.0", "immgration.1",
      "immgration.2", "immgration.3", "immgration.4", "immgration.5", "immgration.6", "immgration.7", "immgration.8", "immgration.9", "immgration.10")
levels(df$ostwest) <- c("ostwest.no", "ostwest.yes")
levels(df$political_interest) <- c("political_interest.low", "political_interest.low_medium","political_interest.medium", "political_interest.medium_high", "political_interest.high")
levels(df$income) <- c("income.low", "income.low_medium","income.medium", "income.medium_high", "income.high")
levels(df$gender) <- c("gender.male", "gender.female")

#Final structure
str(df)

```

## 1.3 - Filter unwanted outliers.

As all the variables are categorical, there are not outliers.

## 1.4 - Handle missing data

Neither individuals nor features has missing values.

```{r include=FALSE}
colnames(df)

# DETECTING MISSING VALUES
which(is.na(df$vote)) 
which(is.na(df$egoposition_immigration)) 
which(is.na(df$ostwest)) 
which(is.na(df$political_interest)) 
which(is.na(df$income)) 
which(is.na(df$gender)) 

# PER INDIVIDUAL
mis_ind = rowSums(is.na(df))
mis_ind
df[which(mis_ind>0),] # Show individuals with some NA value

# PER FEATURE
mis_col = colSums(is.na(df))
mis_col
df[,which(mis_col>0)] # Show features with some NA value

```

## 1.5 - Data balancing

We can observe that the dataset that we are working with it is unbalanced on its target
variable.

```{r include=FALSE}

voteTable <- data.frame("amount" = table(df$vote))

ggplot(voteTable, aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of votes (Target variable)") +
  theme_void() # remove background, grid, numeric labels

#(?) hem de balancejar el dataset? podem fer servir el que volguem? 


```

# 2 - Data Exploration

## 2.1 - Derivation of New variables

```{r include=FALSE}

#Dimension reduction of egoposition immigration from 10 to 3.
df$egoposition_immigration_red <- df$egoposition_immigration

levels(df$egoposition_immigration_red) <- list("immigration.open" = c("immgration.0", "immgration.1", "immgration.2"), 
    "immigration.mid" = c("immgration.3", "immgration.4","immgration.5"),
    "immigration.restrictive" = c("immgration.6", "immgration.7", "immgration.8", "immgration.9", "immgration.10"))

df$egoposition_immigration_red2 <- df$egoposition_immigration

levels(df$egoposition_immigration_red2) <- list("immigration.open" = c("immgration.0", "immgration.1", "immgration.2"), 
    "immigration.open_moderate" = c("immgration.3", "immgration.4"),
    "immigration.moderate" = c("immgration.3", "immgration.5"),
    "immigration.moderate_restrictive" = c("immgration.6", "immgration.7"),  "immigration.restrictive" = c("immgration.8", "immgration.9", "immgration.10"))

# Political Orientation
df$politicalOrientation <- df$vote

levels(df$politicalOrientation) <- list("politicalOrientation.right"=c("vote.AfD"),
            "politicalOrientation.center"=c("vote.CDU/CSU", "vote.FDP","vote.SPD"),
            "politicalOrientation.left"=c("vote.Gruene", "vote.LINKE"))


```

## 2.2 - Data Analysis

-   We can observe that we have more male voters.
-   We can oberve that there is a difference in the income between genders.
-   Political interest 0 is residual, may be we can delete it

```{r include=FALSE}

# TARGET VARIABLE: VOTE
pie(table(df$vote),labels = names(table(df$vote)), col=rainbow(length(table(df$vote))), main="Distribution of votes (Target variable)")

ggplot(df, aes(vote)) + 
  geom_bar(aes(y = (..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) +
  ylab("relative frequencies")

# EXPLANATORY VARIABLE

ggplot(data.frame("amount" = table(df$egoposition_immigration)), aes(x=amount.Var1, y=amount.Freq)) +
  geom_bar(stat = "identity") +
  xlab("Frequency") +
  ylab("egoposition_immigration") +
  ggtitle("Count of egoposition_immigration") +
  theme(plot.title = element_text(hjust = 0.5)) +
  coord_flip()


ggplot(data.frame("amount" = table(df$egoposition_immigration_red)), aes(x=amount.Var1, y=amount.Freq)) +
  geom_bar(stat = "identity") +
  xlab("Frequency") +
  ylab("egoposition_immigration") +
  ggtitle("Count of egoposition_immigration") +
  theme(plot.title = element_text(hjust = 0.5)) +
  coord_flip()

ggplot(data.frame("amount" = table(df$ostwest)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of ostwest") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Ostwest")

ggplot(data.frame("amount" = table(df$political_interest)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of political_interest") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Political Interest")

ggplot(data.frame("amount" = table(df$income)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of income") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Income")

ggplot(data.frame("amount" = table(df$gender)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of gender") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Gender")

colnames(df)
```

## 2.3 - Profiling Target Variable: Vote

```{r include=FALSE}

ggplot(df, aes(x= income,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$income))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="Income") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

ggplot(df, aes(x= gender,  group=vote)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$gender))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="Gender") +
    facet_grid(~vote) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

ggplot(df, aes(x= vote,  group=income)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$vote))), stat="count") +
    labs(y = "Percentage", fill="Vote") +
    facet_grid(~income) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


ggplot(df, aes(x= ostwest,  group=income)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$ostwest))), stat="count") +
    labs(y = "Percentage", fill="Ostwest") +
    facet_grid(~income) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


ggplot(df, aes(x= vote,  group=egoposition_immigration_red)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$vote))), stat="count") +
    labs(y = "Percentage", fill="Vote") +
    facet_grid(~egoposition_immigration_red) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

ggplot(df, aes(x= income,  group=egoposition_immigration_red)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$income))), stat="count") +
    labs(y = "Percentage", fill="Income") +
    facet_grid(~egoposition_immigration_red) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

#### MOURE ADALT?
names(df)
res.cat=catdes(df[,c(1,9,3,4,5,6)], 1) 
res.cat$test.chi2
res.cat$category

#plots of the variables that influentiate vote usign catdes

counts <- table(df$ostwest, df$vote)
barplot(counts, 
        xlab="Number of Votes", col=topo.colors(2),
        legend = rownames(counts),  beside=TRUE, 
        args.legend = list(x = "top"))


#As the dataset is very unbalanced we can apply porcentual plots.
ggplot(df, aes(x= gender,  group=vote)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$gender))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Gender") +
    facet_grid(~vote) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

## ORIENTACIÓ POLITCA VS GEnDER
ggplot(df, aes(x= politicalOrientation,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$politicalOrientation))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


## ORIENTACIÓ POLITCA VS egoposition_immigration_red
ggplot(df, aes(x= politicalOrientation,  group=egoposition_immigration_red2)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$politicalOrientation))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="day") +
    facet_grid(~egoposition_immigration_red2) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

ggplot(df, aes(x= ostwest,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$ostwest))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

ggplot(df, aes(x= political_interest,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$political_interest))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


### OSTWEST FILTERS

ggplot(df[df$ostwest=='ostwest.yes',], aes(x= political_interest,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$political_interest))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Interest (ostwest.yes)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# Curios les noies, a OSTWEST.NO tenen interes politic mes alt
ggplot(df[df$ostwest=='ostwest.no',], aes(x= political_interest,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$political_interest))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Interest (ostwest.no)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# CURIOS OSTWEST.NO els vots Masculins i Femenins estan mes radicalitzats
ggplot(df[df$ostwest=='ostwest.yes',], aes(x= politicalOrientation,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$politicalOrientation))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation (ostwest.yes)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


ggplot(df[df$ostwest=='ostwest.no',], aes(x= politicalOrientation,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$politicalOrientation))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation (ostwest.no)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


############################ MIRARHO PER PARTITS POLITICS!
ggplot(df[df$ostwest=='ostwest.yes',], aes(x= vote,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$vote))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation (ostwest.yes)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


ggplot(df[df$ostwest=='ostwest.no',], aes(x= vote,  group=gender)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$vote))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Political Orientation (ostwest.no)") +
    facet_grid(~gender) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# Figure 3-6: Distribution of votes grouped by income
ggplot(df, aes(x=vote,  group=income)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$vote))), stat="count") +
    labs(y = "Percent", fill="Vote") +
    facet_grid(~income) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# Figure 3-7: Distribution of AfD votes by gender grouped by income
ggplot(df[df$vote=='vote.AfD',], aes(x=gender,  group=income)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$gender))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="Income (vote=AfD)") +
    facet_grid(~income) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# Figure 3-8: Distribution of immigration opinion grouped by political parties
ggplot(df, aes(x= egoposition_immigration_red,  group=vote)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$egoposition_immigration_red))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="egoposition_immigration_red") +
    facet_grid(~vote) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

#  Figure 3-9: Distribution of AfD votes by income grouped by immigration opinion
ggplot(df[df$vote=='vote.AfD',], aes(x=income,  group=egoposition_immigration_red)) + 
    geom_bar(aes(y = ..count.., fill = factor(..x..,labels=levels(df$income)[2:5])), stat="count") +
    geom_text(aes( label = ..count..,
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Frequency", fill="Income (vote=AfD)") +
    facet_grid(~egoposition_immigration_red) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

#  Figure 3-13: Distribution of Gruene votes by gender grouped by income
ggplot(df[df$vote=='vote.Gruene',], aes(x=gender,  group=income)) + 
    geom_bar(aes(y = ..count.., fill = factor(..x..,labels=levels(df$gender))), stat="count") +
    geom_text(aes( label = ..count..,
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Frequency", fill="Income (vote=Gruene)") +
    facet_grid(~income) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

```

## 2.4 - Profiling Political Orientation

```{r include=FALSE}

names(df)
res.cat=catdes(df[,c(11,9,3,4,5,6)], 1) 
res.cat$test.chi2
res.cat$category

# Figure 3-16: Distribution of politicalOrientation
ggplot(data.frame("amount" = table(df$politicalOrientation)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of politicalOrientation") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Political Orientation")

# Figure 3-18: Distribution of politicalOrientation grouped by ostwest
ggplot(data.frame("amount" = table(df[df$ostwest=='ostwest.no',]$politicalOrientation)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of Ostwest:No votes") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Political Interest")
ggplot(data.frame("amount" = table(df[df$ostwest=='ostwest.yes',]$politicalOrientation)), aes(x="", y=amount.Freq, fill=amount.Var1)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  ggtitle("Distribution of Ostwest:Yes votes") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_discrete(name = "Political Interest")

# Figure 3-20: Distribution of immigration opinion grouped by politicalOrientation
ggplot(df, aes(x= egoposition_immigration_red,  group=politicalOrientation)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$egoposition_immigration_red))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="egoposition_immigration_red") +
    facet_grid(~politicalOrientation) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )

# political orientation x gender
ggplot(df, aes(x= gender,  group=politicalOrientation)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$gender))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="gender") +
    facet_grid(~politicalOrientation) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() 
    )


# political orientation x ostwest
ggplot(df, aes(x= ostwest,  group=politicalOrientation)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$ostwest))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="ostwest") +
    facet_grid(~politicalOrientation) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() )


# political orientation x income
ggplot(df, aes(x= income,  group=politicalOrientation)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..,labels=levels(df$income))), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percentage", fill="income") +
    facet_grid(~politicalOrientation) +
    scale_y_continuous(labels = scales::percent) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank() )




```

# 3 - Feature Selection

```{r include=FALSE}

```

# 4 - Modeling

## 4.1 - Political Orientation Modeling

### 4.1.1 - Binary model for Right and Left + Center

```{r include=FALSE}
# With baseline reparametrization (To mantain the configuration)
options(contrasts=c("contr.treatment","contr.treatment"))

df$politicalOrientationBinary2<-ifelse(df$politicalOrientation=="politicalOrientation.left",1,0)
df$politicalOrientationBinary2<-factor(df$politicalOrientationBinary2,labels=c("center_right","left"))


set.seed(1234567)
llwork <- sample(1:nrow(df),round(0.8*nrow(df),dig=0))
dfwork <- df[llwork,]
dftest <- df[-llwork,]



bm1 <- glm( politicalOrientationBinary2 ~ 1, family="binomial",data=dfwork)
bm2 <- glm( politicalOrientationBinary2 ~ egoposition_immigration+political_interest+income+gender+ostwest, family="binomial",data=dfwork)
bm3 <- glm( politicalOrientationBinary2 ~ egoposition_immigration + gender + ostwest, family="binomial",data=dfwork)


bm2$null.dev - bm2$dev
bm3$null.dev - bm3$dev


AIC(bm2, bm3) # hm1m3 325.7325
step(bm2)
anova(bm2, bm3, test="Chisq")
plot(allEffects(bm3))



pred <- predict(bm3, newdata = dftest, type = "response")

dftest$predictions <- pred
dftest$idx <- c(1:length(dftest$predictions))

ggplot(dftest, aes(x=idx, y=predictions, color=politicalOrientationBinary2)) +
  geom_point()

pred <- ifelse(pred > 0.5,1,0)

tt <- table(pred, dftest$politicalOrientationBinary2)
tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))


```

### 4.1.2 - Binary model for Right and Left + Center (Recalculating threshold)

```{r}
df$politicalOrientationBinary<-ifelse(df$politicalOrientation=="politicalOrientation.right",1,0)
df$politicalOrientationBinary<-factor(df$politicalOrientationBinary,labels=c("left_center","right"))

set.seed(1234567)
llwork <- sample(1:nrow(df),round(0.8*nrow(df),dig=0))
dfwork <- df[llwork,]
dftest <- df[-llwork,]

bm0 <- glm( politicalOrientationBinary ~ egoposition_immigration, family="binomial",data=dfwork)
bm1 <- glm( politicalOrientationBinary ~ egoposition_immigration + ostwest, family="binomial",data=dfwork)
bm2 <- glm( politicalOrientationBinary ~ egoposition_immigration + political_interest + income + gender + ostwest, family="binomial",data=dfwork)
bm3 <- glm( politicalOrientationBinary ~ egoposition_immigration_red + gender + ostwest, family="binomial",data=dfwork)
bm4 <- glm( politicalOrientationBinary ~ egoposition_immigration * gender * ostwest, family="binomial",data=dfwork)

bm0$null.dev - bm0$dev
bm1$null.dev - bm1$dev
bm2$null.dev - bm2$dev
bm3$null.dev - bm3$dev
bm4$null.dev - bm4$dev

AIC(bm0, bm1, bm2, bm3, bm4) # hm1m3 325.7325
step(bm4)
step(bm2)
anova(bm2, bm3, test="Chisq")
plot(allEffects(bm3))


pred <- predict(bm3, newdata = dftest, type = "response")

dftest$predictions <- pred
dftest$idx <- c(1:length(dftest$predictions))

ggplot(dftest, aes(x=idx, y=predictions, color=politicalOrientationBinary)) +
  geom_point()

#pred <- ifelse(pred > 0.5,1,0)
pred <- ifelse(pred > 0.18,'right', 'left_center')

tt <- table(pred, dftest$politicalOrientationBinary)
tt

diag(tt)
(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))


plot(allEffects(bm3))
summary(bm3)


newdf <- df[df$politicalOrientation %in% c('politicalOrientation.left','politicalOrientation.center'), ]
newdf$politicalOrientationBinary<-ifelse(newdf$politicalOrientation=="politicalOrientation.left",1,0)
newdf$politicalOrientationBinary<-factor(newdf$politicalOrientationBinary,labels=c("left","center"))

llwork <- sample(1:nrow(newdf),round(0.8*nrow(newdf),dig=0))
dfwork <- newdf[llwork,]
dftest <- newdf[-llwork,]

bm0 <- glm( politicalOrientation ~ egoposition_immigration, family="binomial",data=dfwork)
bm1 <- glm( politicalOrientation ~ egoposition_immigration + ostwest, family="binomial",data=dfwork)
bm2 <- glm( politicalOrientation ~ egoposition_immigration+political_interest+income+gender+ostwest, family="binomial",data=dfwork)
bm3 <- glm( politicalOrientation ~ egoposition_immigration + gender + ostwest, family="binomial",data=dfwork)
bm4 <- glm( politicalOrientation ~ egoposition_immigration * gender * ostwest, family="binomial",data=dfwork)

bm0$null.dev - bm0$dev
bm1$null.dev - bm1$dev
bm2$null.dev - bm2$dev
bm3$null.dev - bm3$dev
bm4$null.dev - bm4$dev

AIC(bm0,bm1,bm2, bm3, bm4)
step(bm2)
anova(bm2, bm3, test="Chisq") # After step seems better to keep bm2??
plot(allEffects(bm3))


pred <- predict(bm3, newdata = dftest, type = "response")

dftest$predictions <- pred
dftest$idx <- c(1:length(dftest$predictions))

ggplot(dftest, aes(x=idx, y=predictions, color=politicalOrientation)) +
  geom_point()

predClass <- ifelse(pred > 0.31,'Left','Center')
dftest$predictedClass <- predClass

tt <- table(dftest$predictedClass, dftest$politicalOrientationBinary)
tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))


```

### 4.1.3 - Model for Center and Left

```{r}

set.seed(1234567)

newdf <- df[df$politicalOrientation %in% c('politicalOrientation.left','politicalOrientation.center'), ]
newdf$politicalOrientationBinary<-ifelse(newdf$politicalOrientation=="politicalOrientation.left",1,0)
newdf$politicalOrientationBinary<-factor(newdf$politicalOrientationBinary,labels=c("left","center"))

llwork <- sample(1:nrow(newdf),round(0.8*nrow(newdf),dig=0))
dfwork <- newdf[llwork,]
dftest <- newdf[-llwork,]

bm2.1 <- glm( politicalOrientation ~ 1, family="binomial",data=dfwork)
bm2.2 <- glm( politicalOrientation ~ egoposition_immigration+political_interest+income+gender+ostwest, family="binomial",data=dfwork)
bm2.3 <- glm( politicalOrientation ~ egoposition_immigration + gender + ostwest, family="binomial",data=dfwork)


# Necesari? 
#bm2.2$null.dev - bm2.2$dev
#bm2.3$null.dev - bm2.3$dev


AIC(bm2.2, bm2.3) # bm3 288.8330
step(bm2.2)
anova(bm2.2, bm2.3, test="Chisq") # After step seems better to keep bm2??
plot(allEffects(bm2.3))


pred <- predict(bm2.3, newdata = dftest, type = "response")

dftest$predictions <- pred
dftest$idx <- c(1:length(dftest$predictions))

ggplot(dftest, aes(x=idx, y=predictions, color=politicalOrientation)) +
  geom_point() +
  geom_hline(yintercept=0.31)

predClass <- ifelse(pred > 0.31,'Left','Center')
dftest$predictedClass <- predClass

tt <- table(dftest$predictedClass, dftest$politicalOrientationBinary)
tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))

```

### 4.1.4 - Multinom model for Right / Center / Left

```{r}

set.seed(123456)
llwork <- sample(1:nrow(df),round(0.8*nrow(df),dig=0))
dfwork <- df[llwork,]
dftest <- df[-llwork,]

?multinom

ones<-c(rep(1, 1000))
mm0 <-multinom( politicalOrientation~1, data=df,weight=ones)
mm1 <-multinom( politicalOrientation~egoposition_immigration_red, data=df,weight=ones )
mm2 <-multinom( politicalOrientation~ostwest, data=df,weight=ones )
mm3 <-multinom( politicalOrientation~political_interest, data=df,weight=ones )
mm4 <-multinom( politicalOrientation~income, data=df,weight=ones )
mm5 <-multinom( politicalOrientation~gender, data=df,weight=ones )
mm6 <-multinom( politicalOrientation~egoposition_immigration_red2, data=df,weight=ones )
mm7 <-multinom( politicalOrientation~egoposition_immigration, data=df,weight=ones )
mm8 <-multinom( politicalOrientation~egoposition_immigration_red+gender, data=df,weight=ones )
mm9 <-multinom( vote~egoposition_immigration+political_interest+income+gender+ostwest, data=df,weight=ones, Hess=TRUE )
mm10 <-multinom( politicalOrientation ~ egoposition_immigration+political_interest+income+gender+ostwest, data=df,weight=ones, Hess=TRUE )
mm11 <-multinom( politicalOrientation ~ egoposition_immigration+political_interest+income+gender+ostwest, data=df,weight=ones, Hess=TRUE )
mm12 <- step(mm11)

#comparar modelos
mm0$dev - mm0$dev
mm0$dev - mm1$dev
mm0$dev - mm2$dev
mm0$dev - mm3$dev
mm0$dev - mm4$dev
mm0$dev - mm5$dev
mm0$dev - mm6$dev
mm0$dev - mm7$dev
mm0$dev - mm8$dev
mm0$dev - mm9$dev
mm0$dev - mm10$dev
mm0$dev - mm11$dev
mm0$dev - mm12$dev

AIC(mm0,mm1,mm2,mm3,mm4,mm5,mm6,mm7,mm8,mm9,mm10,mm11) 

df.fin <- mm10
prob.vote <- df.fin$fit
tt <- table(predict(mm10,  dftest, type='class'), dftest$politicalOrientation)
tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))




#Efectos modelos
plot(allEffects(mm10))

# Sons effect
#coef(hm1m3)
#exp(coef(hm1m3))
#100*(exp((coef(hm1m3))[2]) - 1)

# Having sons decreases on average the relative probability of working vs non_working by 79.31% all else being equal
#prop.table(table(womenlf$bwork))

# Income effect: odds of working decrease for each year by 4.14% and in 0.01 probability units
#coef(hm1m3)[3]
#exp(coef(hm1m3))[3]
#100*(exp(coef(hm1m3))[3] - 1)
```

## 4.2 - Vote Prediction Modeling

### 4.2.1 - Binary model for Left-wing parties: Gruene and LINKE

```{r}
set.seed(1234567)

newdf <- df[df$politicalOrientation =='politicalOrientation.left', ]
newdf$voteBinary<-ifelse(newdf$vote=="vote.Gruene",1,0)
newdf$voteBinary<-factor(newdf$voteBinary,labels=c("LINKE","GRUENE"))

llwork <- sample(1:nrow(newdf),round(0.8*nrow(newdf),dig=0))
dfwork <- newdf[llwork,]
dftest <- newdf[-llwork,]

bm3.1 <- glm( vote ~ 1, family="binomial",data=dfwork)
bm3.2 <- glm( vote ~ egoposition_immigration_red+political_interest+income+gender+ostwest, family="binomial",data=dfwork)
bm3.3 <- glm( vote ~ egoposition_immigration_red + ostwest, family="binomial",data=dfwork)
bm3.4 <- glm( vote ~ egoposition_immigration_red + gender + ostwest, family="binomial",data=dfwork)


# Comparing models
bm3.2$null.dev - bm3.2$dev
bm3.3$null.dev - bm3.3$dev
bm3.4$null.dev - bm3.4$dev

AIC(bm3.2, bm3.3, bm3.4) 
plot(allEffects(bm3.2))
plot(allEffects(bm3.3))
plot(allEffects(bm3.4))

# Validating model 3.2 with Train dataset
pred <- predict(bm3.2, newdata = dfwork, type = "response")
dfwork$predictions <- pred
dfwork$idx <- c(1:length(dfwork$predictions))

ggplot(dfwork, aes(x=idx, y=predictions, color=vote)) +
  geom_point() +
  geom_hline(yintercept=0.45)

predClass <- ifelse(pred <= 0.45,'pred.GRUENE', 'pred.LINKE')
dfwork$predictedClass <- predClass

tt <- table(dfwork$predictedClass, dfwork$voteBinary)
tt <-tt[order(row.names(x = tt)), order(colnames(x = tt))]; tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))

# Validating model 3.3 with Train dataset
pred <- predict(bm3.3, newdata = dfwork, type = "response")
dfwork$predictions <- pred
dfwork$idx <- c(1:length(dfwork$predictions))

ggplot(dfwork, aes(x=idx, y=predictions, color=vote)) +
  geom_point() +
  geom_hline(yintercept=0.45)

predClass <- ifelse(pred <= 0.45,'pred.GRUENE', 'pred.LINKE')
dfwork$predictedClass <- predClass

tt <- table(dfwork$predictedClass, dfwork$voteBinary)
tt <-tt[order(row.names(x = tt)), order(colnames(x = tt))]; tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))

# Validating model 3.4 with Train dataset
pred <- predict(bm3.4, newdata = dfwork, type = "response")
dfwork$predictions <- pred
dfwork$idx <- c(1:length(dfwork$predictions))

ggplot(dfwork, aes(x=idx, y=predictions, color=vote)) +
  geom_point() +
  geom_hline(yintercept=0.45)

predClass <- ifelse(pred <= 0.45,'pred.GRUENE', 'pred.LINKE')
dfwork$predictedClass <- predClass

tt <- table(dfwork$predictedClass, dfwork$voteBinary)
tt <-tt[order(row.names(x = tt)), order(colnames(x = tt))]; tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))

# Validating model 3.4 with Test dataset
pred <- predict(bm3.4, newdata = dftest, type = "response")
dftest$predictions <- pred
dftest$idx <- c(1:length(dftest$predictions))

ggplot(dftest, aes(x=idx, y=predictions, color=vote)) +
  geom_point() +
  geom_hline(yintercept=0.45)

predClass <- ifelse(pred <= 0.45,'pred.GRUENE', 'pred.LINKE')
dftest$predictedClass <- predClass

tt <- table(dftest$predictedClass, dftest$voteBinary)
tt <-tt[order(row.names(x = tt)), order(colnames(x = tt))]; tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))
```

### 4.2.2 - Model SPD / CDU_CSU / FDP

```{r}
set.seed(1234567)

newdf <- df[df$politicalOrientation =='politicalOrientation.center', ]
newdf$votMult<-ifelse(newdf$vote=="vote.SPD","vote.SPD",ifelse(newdf$vote=="vote.CDU/CSU","vote.CDU/CSU","vote.FDP"))
newdf$votMult<-as.factor(newdf$votMult)

llwork <- sample(1:nrow(newdf),round(0.8*nrow(newdf),dig=0))
dfwork <- newdf[llwork,]
dftest <- newdf[-llwork,]

ones<-ifelse(dfwork$votMult=="vote.FDP",1.7,1)
mm1 <- multinom( votMult ~ 1,data=dfwork,weight=ones )
mm2 <- multinom( votMult ~ egoposition_immigration_red+political_interest+income+gender+ostwest, data=dfwork,weight=ones )
mm3 <- multinom( votMult ~ egoposition_immigration_red + ostwest, data=dfwork,weight=ones )
mm4 <- multinom( votMult ~ egoposition_immigration_red + gender + ostwest, data=dfwork,weight=ones )


AIC(mm2, mm3, mm4) # mm2
plot(allEffects(mm2))
plot(allEffects(mm3))
plot(allEffects(mm4))


# Validating model 2 with Train dataset
dfwork$predictedClass <- predict(mm2, newdata = dfwork, type = "class")
tt <- table(dfwork$predictedClass,dfwork$votMult); tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))

# Validating model 3 with Train dataset
dfwork$predictedClass <- predict(mm3, newdata = dfwork, type = "class")
tt <- table(dfwork$predictedClass,dfwork$votMult); tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))

# Validating model 4 with Train dataset
dfwork$predictedClass <- predict(mm4, newdata = dfwork, type = "class")
tt <- table(dfwork$predictedClass,dfwork$votMult); tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))

# Validating model 4 with Test dataset
dftest$predictedClass <- predict(mm2, newdata = dftest, type = "class")
tt <- table(dftest$predictedClass,dftest$votMult); tt

(accuracy <- sum(diag(tt)) / sum(tt))
(precision <- diag(tt) / rowSums(tt))
(recall <- (diag(tt) / colSums(tt)))
(f1 <- (2*precision*recall/(precision+recall)))

```

## 4.3 - Testing the hierarchical model

### 4.3.1 - Right OR Left_Center

```{r}

set.seed(1234567)
df$idx <- c(1:length(df$vote))

df$politicalOrientationBinary<-as.factor(ifelse(df$politicalOrientation=="politicalOrientation.right","right","left_center"))
pred <- predict(bm3, newdata = df, type = "response")
df$predictions <- pred

ggplot(df, aes(x=idx, y=predictions, color=politicalOrientationBinary)) +
  geom_point() +
  geom_hline(yintercept=0.2)

df$predictedPoliticalOrientation <- as.factor(ifelse(pred > 0.2,'pred.Right','pred.Left_Center')) # mantenir el inicial?
df$predictedParty <- as.factor(ifelse(df$predictedPoliticalOrientation == 'pred.Right','pred.AfD','-'))

```

### 4.3.2 - Left OR Center

```{r}

df1<-df[df$predictedPoliticalOrientation=='pred.Left_Center',]
pred <- predict(bm2.3, newdata = df1, type = "response")
df1$predictions <- pred

ggplot(df1, aes(x=idx, y=predictions, color=politicalOrientation)) +
  geom_point() +
  geom_hline(yintercept=0.31)

df1$predictedPoliticalOrientation <- ifelse(pred > 0.31,'pred.Left','pred.Center')

```

### 4.3.3 - Gruene OR LINKE

```{r}

df2<-df1[df1$predictedPoliticalOrientation=='pred.Left',]
pred <- predict(bm3.4, newdata = df2, type = "response")
df2$predictedParty <- ifelse(pred <= 0.45,'pred.Gruene','pred.LINKE')

```

### 4.3.4 - SPD OR CDU/CSU OR FDP

```{r}

df3<-df1[df1$predictedPoliticalOrientation=='pred.Center',]
df3$predictedParty <- predict(mm2, newdata = df3, type = "class")

```

### 4.3.5 - Join datasets and validate the Hierarchical Model

```{r}

dfFull = rbind(df2,df3,df[df$predictedPoliticalOrientation=='pred.Right',])
dfFull$predictedPoliticalOrientation<-as.factor(dfFull$predictedPoliticalOrientation)
dfFull$predictedParty<-as.factor(dfFull$predictedParty)
levels(dfFull$predictedParty) <- c("pred.AfD","pred.Gruene","pred.LINKE","pred.CDU/CSU","pred.FDP","pred.SPD")

tt1 <- table(dfFull$politicalOrientation,dfFull$predictedPoliticalOrientation)
tt1 <-tt1[order(row.names(x = tt1)), order(colnames(x = tt1))]; tt1

(accuracy <- sum(diag(tt1)) / sum(tt1))
(precision <- diag(tt1) / rowSums(tt1))
(recall <- (diag(tt1) / colSums(tt1)))
(f1 <- (2*precision*recall/(precision+recall)))


tt2 <- table(dfFull$vote,dfFull$predictedParty)
tt2 <-tt2[order(row.names(x = tt2)), order(colnames(x = tt2))]; tt2
(accuracy <- sum(diag(tt2)) / sum(tt2))
(precision <- diag(tt2) / rowSums(tt2))
(recall <- (diag(tt2) / colSums(tt2)))
(f1 <- (2*precision*recall/(precision+recall)))

```
